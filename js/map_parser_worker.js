
var commands = {
  parse: function(data, cb) {
    importScripts('World.js', 'BinaryFile.js');
    cb({op: 'world_data', data: new World().loadWithData(data.data).serialize()});
  },
  renderMap: function(data, cb) {
    var tiles = data.tiles;
    var tileColours = { 0: 0x976B4B, 1: 0x808080, 2: 0x1CD85E, 3: 0x1E9648, 4: 0xFDDD03, 5: 0x976B4B, 6: 0xB5A495, 7: 0x964316, 8: 0xB9A417, 9: 0xD9DFDF, 10: 0xBF8F6F, 11: 0x946B50, 12: 0xB61239, 13: 0x4EC5FC, 14: 0x7F5C45, 15: 0xA2785C, 16: 0x505050, 17: 0x636363, 18: 0x7F5C45, 19: 0xB18567, 20: 0x1E9648, 21: 0x946B50, 22: 0x625FA7, 23: 0x8D89DF, 24: 0x6D6AAE, 25: 0x7D7991, 26: 0x5E5561, 27: 0xE3B903, 28: 0x796E61, 29: 0x9C546C, 30: 0xA97D5D, 31: 0x674D62, 32: 0x7A618F, 33: 0xFDDD03, 34: 0xB75819, 35: 0xC1CACB, 36: 0xB9A417, 37: 0x685654, 38: 0x8C8C8C, 39: 0xC37057, 40: 0x925144, 41: 0x454E63, 42: 0xF99851, 43: 0x526556, 44: 0x8A4469, 45: 0x947E18, 46: 0xAEC1C2, 47: 0xD5651A, 48: 0xAFAFAF, 49: 0x0B2EFF, 50: 0x3095AA, 51: 0x9EADAE, 52: 0x1E9648, 53: 0xD3C66F, 54: 0xC8F6FE, 55: 0x7F5C45, 56: 0x41414D, 57: 0x44444C, 58: 0x8E4242, 59: 0x5C4449, 60: 0x8FD71D, 61: 0x63971F, 62: 0x28650D, 63: 0x2A82FA, 64: 0xFA2A51, 65: 0x05C95D, 66: 0xC78B09, 67: 0xA30BD5, 68: 0x19D1E7, 69: 0x855141, 70: 0x5D7FFF, 71: 0xB1AE83, 72: 0x968F6E, 73: 0x0D6524, 74: 0x28650D, 75: 0x0B0B0B, 76: 0x8E4242, 77: 0xEE6646, 78: 0x796E61, 79: 0x5C6298, 80: 0x497811, 81: 0xe5533f, 82: 0xfe5402, 83: 0xfe5402, 84: 0xfe5402, 85: 0xc0c0c0, 86: 0x7F5C45, 87: 0x584430, 88: 0x906850, 89: 0xB18567, 90: 0x606060, 91: 0x188008, 92: 0x323232, 93: 0x503B2F, 94: 0xA87858, 95: 0xF87800, 96: 0x606060, 97: 0x808080, 98: 0xB2B28A, 99: 0x808080, 100: 0xCCB548, 101: 0xB08460, 102: 0x780C08, 103: 0x8D624D, 104: 0x946B50, 105: 0x282828, 106: 0x563E2C, 107: 0x0B508F, 108: 0x5BA9A9, 109: 0x4EC1E3, 110: 0x1E9648, 111: 0x801A34, 112: 0x67627A, 113: 0x1E9648, 114: 0x7F5C45, 115: 0x327FA1, 116: 0xD5C4C5, 117: 0xB5ACBE, 118: 0xD5C4C5, 119: 0x3F3F49, 120: 0x967A7D, 121: 0x2576AB, 122: 0x91BF75, 123: 0x595353, 124: 0x5C4436, 125: 0x81A5FF, 126: 0xDBDBDB, 127: 0x68B3C8, 128: 0x906850, 129: 0x004979, 130: 0xA5A5A5, 131: 0x1A1A1A, 132: 0xC90303, 133: 0x891012, 134: 0x96AE87, 135: 0xFD7272, 136: 0xCCC0C0, 137: 0x8C8C8C, 138: 0x636363, 139: 0x996343, 140: 0x7875B3, 141: 0xAD2323, 142: 0xC90303, 143: 0xC90303, 144: 0xC90303, 145: 0xC01E1E, 146: 0x2BC01E, 147: 0xC7DCDF, 148: 0xD3ECF1, 149: 0xffffff, 150: 0x731736, 151: 0xbaa854, 152: 0x5f5f95, 153: 0xef8d7e, 154: 0xdfdb93, 155: 0x83a2a1, 156: 0xbcbcb1, 157: 0x9989a5, 158: 0x915155, 159: 0x57503f, 160: 0xd4d4d4, 161: 0x90c3e8, 162: 0x92aebf, 163: 0x9188cb, 164: 0xd197bc, 165: 0x5c8faf, 166: 0x817d5d, 167: 0x2f3e57, 168: 0x5a7d53, 169: 0x8097b8, 170: 0x817d5d, 171: 0x7a907e, 172: 0x8097b8, 173: 0x8097b8, 174: 0xfe7902, 175: 0xbba57c, 176: 0x9cc09d, 177: 0xb5c2d9, 178: 0x892880, 179: 0x318672, 180: 0x7e8631, 181: 0x863b31, 182: 0x2b568c, 183: 0x793186, 184: 0x208376, 185: 0x808080, 186: 0x999979, 187: 0x63971f, 188: 0x497811, 189: 0xffffff, 190: 0xb6af82, 191: 0x9e7354, 192: 0x0d6524, 193: 0x3879ff, 194: 0xb2b28a, 195: 0xb74d70, 196: 0x9390b2, 197: 0x61c8e1, 198: 0x202122, 199: 0x9f3a3a, 200: 0xe6bab7, 201: 0xa63f3f, 202: 0x171594, 203: 0xc34343, 204: 0x85212e, 205: 0xb74544, 206: "7cafc9", 207: 0x838383, 208: 0x687986, 209: 0x676767, 210: 0xed1c24, 211: 0x4fbf2d, 212: 0xf5f5f5, 213: 0x897843, 214: 0x676767, 215: 0xfd3e03, 216: 0xbe303e, 217: 0x676767, 218: 0x4d4d4d, 219: 0x676767, 220: 0x563a01, 221: 0xf35e36, 222: 0x841380, 223: 0xa7d29f, 224: 0x7e989d, 225: 0xc86c10, 226: 0x8d3800, 227: 0x46bb93, 228: 0xa87858, 229: 0xff9c0c, 230: 0x5e3e24, 231: 0xc8964a, 232: 0x734144, 233: 0x6bb600, 234: 0x4d4c42, 235: 0xb3bb44, 236: 0xcd733d, 237: 0xfff133, 238: 0xe180ce, 239: 0xcd8647, 240: 0x634732, 241: 0x4d4a48, 242: 0x454b45, 243: 0xc6c4aa, 244: 0xc8f5fd, 245: 0x554545, 246: 0x6d5332, 247: 0x696969, 248: 0xe1623f, 249: 0xdf23dc, 250: 0x636169FF };

    var pixels = new Array(tiles.length);
    var i =0;

    while (i < tiles.length) {
      if (tiles[i].active) {
        if (tiles[i].type in tileColours) {
          pixels[i] = tileColours[tiles[i].type];
        }
        else {
          pixels[i] = 0x00000080;
        }
      }

      i++;
    }
    data.pixels = new Uint32Array(pixels);
    cb({op: 'mapPixels', data: data.pixels});
  }
};



function callBack(a,b) {
  self.postMessage(a,b);
}

onmessage = function(e) {
  var commandName = e.data.op;
  if (commandName in commands) {
    commands[commandName](e.data, callBack);
  }
};
